<!DOCTYPE html>
<html lang="en">
 <head>
  <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"
      integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
   <style>
      ::-webkit-scrollbar {
        width: 10px;
      }
      ::-webkit-scrollbar-track {
        background-color: transparent;
      }
      ::-webkit-scrollbar-thumb {
        border-radius: 10px;
        box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.3);
      }
   </style>
   <meta charset="utf-8" />
<meta http-equiv="x-ua-compatible" content="ie=edge" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no"
/>
<title>
  와글와글 Next.js 서버 배포와 CI / CD 적용기 &#9642; vanGona
</title>
<!--
<meta name="description" content="Next.js 배포 NCloud Platform 프로젝트 기간동안 사용할 수 있는 ncp 무료 크레딧이 있어서, 여러 설정이 용이하도록 직접 배포하였다. 이전에 몇 번 배포 경험이 있어서, 이번 기회에 CI / CD까지 직접해볼 수 있는 좋은 기회라는 생각이 들었다. 배포 과정 평소에도 배포할 때 github을 ssh key로 연결했기 때문에, CI / CD를 진행한다고...">
-->
<link rel="icon" href="/assets/img/dactl.svg" />
<meta
  name="description"
  content="임상심리학자가 개발을 추구하는 건에 대해서
"
/>
<meta
  name="keywords"
  content="와글와글, Next.js, CI / CD"
/>
<link
  rel="canonical"
  href="http://vangona.github.io/posts/waglewagle-bff-deploy"
/>
<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="와글와글 Next.js 서버 배포와 CI / CD 적용기" />
<meta name="twitter:description" content="임상심리학자가 개발을 추구하는 건에 대해서
" />
<meta name="twitter:image" content="http://vangona.github.io" />
<meta name="author" content="" />
<link rel="author" href="" />
<meta property="og:locale" content="" />
<meta property="og:type" content="article" />
<meta property="og:title" content="와글와글 Next.js 서버 배포와 CI / CD 적용기" />
<meta property="og:description" content="임상심리학자가 개발을 추구하는 건에 대해서
" />
<meta
  property="og:url"
  content="http://vangona.github.io/posts/waglewagle-bff-deploy"
/>
<meta property="og:site_name" content="vanGona" />
<link rel="stylesheet" href="/assets/vendor/normalize-css/normalize.css"><link rel="stylesheet" href="/assets/css/main.css"> 
<link
  rel="stylesheet"
  href="https://fonts.googleapis.com/css?family=Rubik:400,400italic,700,700italic"
/>
<style>
  html {
    font-family: "Rubik", -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
  }
</style>
<link rel="stylesheet"
href="/assets/css/bf.css"> 
 <body>
   <div class="wrapper" id="blep">
    <header>
 <div class="menu">
   <div class="logo">
      <a href="/">vanGona</a>
      <object
        type="image/svg+xml"
        data="/assets/img/dactl.svg"
        class="logosvg"
      >
        Your browser does not support svg images
      </object>
   </div>
    <input id="mobile-nav__toggle" type="checkbox" />
   <ul class="mobile-nav">
      <label class="toggle-nav" for="mobile-nav__toggle">
        <i class="fa-solid fa-bars"></i>
      </label>
     <div class="nav__profile">vanGona</div>
     <li class="dropdown ">
        <a
          class="dropdown-toggle"
          role="button"
          data-toggle="dropdown"
          aria-haspopup="true"
          aria-expanded="false"
          href="/humanities"
          >HUMANITIES
        </a>
     <li class="dropdown ">
        <a
          class="dropdown-toggle"
          role="button"
          data-toggle="dropdown"
          aria-haspopup="true"
          aria-expanded="false"
          href="/algorithm"
          >ALGORITHM
        </a>
     <li class="dropdown ">
        <a
          class="dropdown-toggle"
          role="button"
          data-toggle="dropdown"
          aria-haspopup="true"
          aria-expanded="false"
          href="/languages"
          >LANGUAGES
        </a>
     <li class="dropdown ">
        <a
          class="dropdown-toggle"
          role="button"
          data-toggle="dropdown"
          aria-haspopup="true"
          aria-expanded="false"
          href="/cs"
          >SCIENCE
        </a>
     <li class="dropdown ">
        <a
          class="dropdown-toggle"
          role="button"
          data-toggle="dropdown"
          aria-haspopup="true"
          aria-expanded="false"
          href="/projects"
          >PROJECTS
        </a>
   </ul>
   <ul class="visible-links"> 
     <li class="dropdown ">
        <a
          class="dropdown-toggle"
          role="button"
          data-toggle="dropdown"
          aria-haspopup="true"
          aria-expanded="false"
          href="/humanities"
          >HUMANITIES
          <i class="fa fa-caret-down fa-sm" aria-hidden="true"></i
          ><span class="caret"></span
        ></a>
     <li class="dropdown ">
        <a
          class="dropdown-toggle"
          role="button"
          data-toggle="dropdown"
          aria-haspopup="true"
          aria-expanded="false"
          href="/algorithm"
          >ALGORITHM
          <i class="fa fa-caret-down fa-sm" aria-hidden="true"></i
          ><span class="caret"></span
        ></a>
     <li class="dropdown ">
        <a
          class="dropdown-toggle"
          role="button"
          data-toggle="dropdown"
          aria-haspopup="true"
          aria-expanded="false"
          href="/languages"
          >LANGUAGES
          <i class="fa fa-caret-down fa-sm" aria-hidden="true"></i
          ><span class="caret"></span
        ></a>
     <li class="dropdown ">
        <a
          class="dropdown-toggle"
          role="button"
          data-toggle="dropdown"
          aria-haspopup="true"
          aria-expanded="false"
          href="/cs"
          >SCIENCE
          <i class="fa fa-caret-down fa-sm" aria-hidden="true"></i
          ><span class="caret"></span
        ></a>
     <li class="dropdown ">
        <a
          class="dropdown-toggle"
          role="button"
          data-toggle="dropdown"
          aria-haspopup="true"
          aria-expanded="false"
          href="/projects"
          >PROJECTS
          <i class="fa fa-caret-down fa-sm" aria-hidden="true"></i
          ><span class="caret"></span
        ></a>
   </ul>
 </div>
 <div class="social">
   <ul>
     <li>
        <a
          href="https://github.com/vangona"
          target="_blank"
          class="smaller"
        >
          <span class="icon-github"></span>
        </a>
     <li>
        <a
          href="https://youtube.com/뜬구름 공작소"
          target="_blank"
          class="smaller"
        >
          <span class="icon-youtube"></span>
        </a>
     <li>
        <a
          href="https://instagram.com/my_own_drawer_"
          target="_blank"
          class="smaller"
        >
          <i class="fa-brands fa-instagram"></i>
        </a>
     <li>
        <a href="mailto:rlarhksrud14@gmail.com" target="_blank">
          <span class="icon-mail_outline"></span>
        </a>
     <li>
        <a href="#" onclick="switchTheme()" title="Switch theme?">
          <span class="icon-invert_colors" id="theme-switcher"></span>
        </a>
   </ul>
 </div>
</header>
<article class="post">
<style>
  .waglewagle-bff-deploy {
    margin-bottom: 2em;
  }
  .waglewagle-bff-deploy::before {
    background-image: url('https://source.unsplash.com/random');
    background-size: cover;
    -webkit-filter: grayscale(1) brightness(0.5) contrast(0.5);
    content:'';
    position:absolute;
    width: 100%;
    left: 0;
    top: 0;
    z-index: -2;
  }
  .waglewagle-bff-deploy::after {
    content:'';
    position:absolute;
    width: 100%;
    left: 0;
    top: 0;
    background-color: rgba(100,0,255,0.8);
    /*mix-blend-mode: darken;
    mix-blend-mode: color-burn;
    mix-blend-mode: hard-light;*/
    mix-blend-mode: overlay;
    z-index: -1;
  }
  .waglewagle-bff-deploy-container,
  .waglewagle-bff-deploy-container::before,
  .waglewagle-bff-deploy-container::after {
    height: 25rem;
  }
  .waglewagle-bff-deploy-bleed-container,
  .waglewagle-bff-deploy-bleed-container::before,
  .waglewagle-bff-deploy-bleed-container::after {
    height: 35rem;
  }
    @media (max-width: 48rem) {
        .waglewagle-bff-deploy-container,
        .waglewagle-bff-deploy-container::before,
        .waglewagle-bff-deploy-container::after{
            height: 20rem;
            margin-bottom: 3rem;
        }
    }
</style>
 <div class="post-title-container
  waglewagle-bff-deploy waglewagle-bff-deploy-bleed-container bleed-hero-container
    ">
    <!--Post hero image source-->
   <div class="heading-container hero-heading hero-heading-post">
     <h1>
          와글와글 Next.js 서버 배포와 CI / CD 적용기
     </h1>
     <div class="post-meta">
        <span>25/11/2022</span>
        <span>
              <a href="/tag/와글와글">#와글와글</a>
              <a href="/tag/Next.js">#Next.js</a>
              <a href="/tag/CI / CD">#CI / CD</a>
        </span>
     </div>
   </div>
 </div>
   <h1 id="nextjs-배포">Next.js 배포</h1>

<h2 id="ncloud-platform">NCloud Platform</h2>

<ul>
 <li>프로젝트 기간동안 사용할 수 있는 ncp 무료 크레딧이 있어서, 여러 설정이 용이하도록 직접 배포하였다.
 <li>이전에 몇 번 배포 경험이 있어서, 이번 기회에 CI / CD까지 직접해볼 수 있는 좋은 기회라는 생각이 들었다.
</ul>

<h2 id="배포-과정">배포 과정</h2>

<ul>
 <li>평소에도 배포할 때 github을 ssh key로 연결했기 때문에, CI / CD를 진행한다고 해도 큰 차이는 없었다.
 <li>인스턴스를 생성하고, ACG를 통해서 사용할 port를 열어준 뒤 인스턴스를 띄웠다.
 <li>이후에 nvm을 통해 node를 설치하고, ssh key를 통해 github을 연결하여 github에서 코드를 받아서 배포할 수 있었다.
</ul>

<h2 id="bff-backend-for-frontend">BFF (Backend For Frontend)</h2>

<ul>
 <li>이번 프로젝트에서 NGinx 서버가 별도로 있지만 클라이언트의 서버를 띄운 이유는 Next.js의 SSR을 위해서였다.
 <li>Next.js에서의 SSR은 HTTP 요청이 들어왔을 때, 필요한 HTML을 서버에서 렌더링해서 응답해주는 방식인데 이를 위해서는 BFF가 필요하다.
 <li>이를 통해서 클라이언트 기기에 덜 의존적인 렌더링이 가능하며, 여러 보안적인 이점도 있다.
</ul>

<h1 id="nextjs-ci--cd를-위해-산넘고-물건너기">Next.js CI / CD를 위해 산넘고 물건너기</h1>

<h2 id="push-이벤트-감지-안됨">push 이벤트 감지 안됨</h2>

<hr />

<h3 id="꿀잠-잘-기대에-가득찬-ci--cd">꿀잠 잘 기대에 가득찬 CI / CD</h3>

<ul>
 <li>기대에 가득 차서 push를 했지만, 어림도 없지 push 이벤트는 동작하지 않았다.
</ul>

<h3 id="이-문제는-잠시-뒤로-미룹시다">이 문제는 잠시 뒤로 미룹시다.</h3>

<ul>
 <li>workflow dispatch 명령어를 yaml 파일에 추가하여 수동으로 먼저 동작했다.
 <li>수동으로 job 동작을 확인한 뒤, 여러가지 실험을 진행했다.
</ul>

<h3 id="문제-해결">문제 해결</h3>

<ul>
 <li>알고보니 이벤트가 발생하는 해당 브랜치에도 workflow 폴더와 yaml 파일이 있어야했다.
 <li>이를 통해 해결되었다.
</ul>

<h2 id="github-actions에서만-npm이-없다고-뜨는-에러">github actions에서만 npm이 없다고 뜨는 에러</h2>

<hr />

<h3 id="고난의-시작">고난의 시작</h3>

<ul>
 <li>수동으로 job 동작을 확인하는데, npm이 없다는 에러가 떴다.
</ul>

<h3 id="원인-파악---nvm-제거-후-nodejs-수동-설치">원인 파악 - nvm 제거 후 nodejs 수동 설치</h3>

<ul>
 <li>이전 트러블 때, github actions에서 nvm의 nodejs에는 접근을 할 수 없었다.
 <li>이를 위해 nvm의 nodejs를 삭제하고, 따로 nodejs를 직접 설치해야했다.
 <li>이를 통해 nodejs에 접근이 가능해지고, npm install이 정상적으로 동작하는 걸 확인하였다.
</ul>

<h3 id="다시-찾아온-문제---nvm-환경변수">다시 찾아온 문제 - nvm 환경변수</h3>

<ul>
 <li>갑자기 pm2가 동작하지 않았다.
 <li>확인해보니 클라우드 서버에서는 pm2가 npm global로 설정이 되어있었다.
 <li>github actions에서 npm ls -g를 찍어보니 pm2가 없었다.
 <li>다시 조사해보니 nvm에서 설정해둔 $PATH 환경변수가 남아있었다.
 <li>bashrc에서 $PATH 환경변수를 지우고 putty를 재실행해서 환경변수를 초기화하였다.
</ul>

<h3 id="문제-해결-1">문제 해결</h3>

<ul>
 <li>이후 nvm의 $PATH가 아닌 새로 설치한 nodejs의 $PATH가 되며 해결되었다.
</ul>

</article>
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'dactl';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
<aside class="related">
<h2>Related posts</h2>
<ul class="related-posts">
</aside>
<footer>
    <span>임상심리학자가 개발을 추구하는 건에 대해서
</span>
    <span>written by Kim Kwan-kyoung</span>
</footer>
   </div>
<script type="text/javascript" src="/assets/js/theme.js"></script>
<script type="text/javascript" src="/assets/js/barefoot.js"></script>
  
